<!DOCTYPE html>
<html>
<head>
    <title>Добавление перевала</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .image-preview { max-width: 100px; max-height: 100px; margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Добавить новый перевал</h1>

    <form id="perevalForm">
        {% csrf_token %}
        <!-- User Data -->
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="email" required>
        </div>

        <div class="form-group">
            <label>Имя:</label>
            <input type="text" id="firstName" required>
        </div>

        <div class="form-group">
            <label>Фамилия:</label>
            <input type="text" id="lastName" required>
        </div>

        <div class="form-group">
            <label>Телефон:</label>
            <input type="tel" id="phone">
        </div>

        <!-- Coordinates -->
        <div class="form-group">
            <label>Широта:</label>
            <input type="number" step="0.000001" id="latitude">
        </div>

        <div class="form-group">
            <label>Долгота:</label>
            <input type="number" step="0.000001" id="longitude">
        </div>

        <div class="form-group">
            <label>Высота:</label>
            <input type="number" id="height">
        </div>

        <!-- Pereval Info -->
        <div class="form-group">
            <label>Название перевала:</label>
            <input type="text" id="title" required>
        </div>

        <div class="form-group">
            <label>Красивое название:</label>
            <input type="text" id="beautyTitle">
        </div>

        <!-- Levels -->
        <div class="form-group">
            <label>Сложность (зима):</label>
            <select id="levelWinter">
                <option value="">Не указано</option>
                <option value="1A">1A</option>
                <option value="1B">1B</option>
                <!-- другие варианты -->
            </select>
        </div>

        <!-- Images -->
        <div class="form-group">
            <label>Фотографии:</label>
            <input type="file" id="images" multiple accept="image/*">
            <div id="imagePreviews"></div>
        </div>

        <button type="submit">Отправить</button>
    </form>

    <div id="status"></div>

    <script>
        document.getElementById('perevalForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Собираем данные формы
            const formData = {
                user: {
                    email: document.getElementById('email').value,
                    first_name: document.getElementById('firstName').value,
                    last_name: document.getElementById('lastName').value,
                    phone: document.getElementById('phone').value
                },
                coord: {
                    latitude: parseFloat(document.getElementById('latitude').value) || null,
                    longitude: parseFloat(document.getElementById('longitude').value) || null,
                    height: parseFloat(document.getElementById('height').value) || null
                },
                beautyTitle: document.getElementById('beautyTitle').value,
                title: document.getElementById('title').value,
                level_winter: document.getElementById('levelWinter').value,
                images: []
            };

            // Обрабатываем изображения
            const imageFiles = document.getElementById('images').files;
            for (let i = 0; i < imageFiles.length; i++) {
                const base64 = await toBase64(imageFiles[i]);
                formData.images.push({
                    data: base64.split(',')[1], // Удаляем префикс data:image/...
                    title: imageFiles[i].name
                });
            }

            // Отправляем данные на сервер
            try {
                const response = await fetch('/api/submitData/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') // Для Django CSRF защиты
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('status').textContent = 'Успешно отправлено! ID: ' + result.id;
                    document.getElementById('status').style.color = 'green';
                } else {
                    throw new Error(result.message || 'Ошибка сервера');
                }
            } catch (error) {
                document.getElementById('status').textContent = 'Ошибка: ' + error.message;
                document.getElementById('status').style.color = 'red';
                console.error('Error:', error);
            }
        });

        // Превью изображений
        document.getElementById('images').addEventListener('change', function(e) {
            const previews = document.getElementById('imagePreviews');
            previews.innerHTML = '';

            for (let file of e.target.files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.classList.add('image-preview');
                    previews.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        // Вспомогательные функции
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>